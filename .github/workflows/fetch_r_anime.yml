name: Fetch r/anime threads daily

on:
  schedule:
    - cron: '0 22 * * *'  # UTCで毎日22:00（日本時間07:00）に実行。必要に応じて変更してね
  workflow_dispatch: {}  # 手動実行も可

permissions:
  contents: write  # リポジトリに書き込むために必要

jobs:
  fetch_and_match:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch AniList (create data/anilist.json)
        run: |
          echo "Fetching AniList titles to data/anilist.json"
          python fetch_anilist.py

      # Test-mode: use existing snapshot instead of fetching from Reddit
      - name: Use existing reddit snapshot (test mode)
        run: |
          echo "Test mode: using existing data/reddit_latest.json instead of fetching from Reddit"
          if [ -f data/reddit_latest.json ]; then
            ls -l data/reddit_latest.json
          else
            echo "ERROR: data/reddit_latest.json not found; create or run fetch_r_anime.py once to generate it"
            exit 1
          fi

      # The real reddit fetch step is commented out for faster test runs.
      # To re-enable live fetching, uncomment the following block.
      # ↓ ここから reddit_latest.json を fetch_r_anime.py で取得するステップ ※コメントアウトすると既存のreddit_latest.jsonを使うテストモードになる
      - name: Fetch reddit data
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
        run: python fetch_r_anime.py
      # ↑ ここまで

      - name: Match AniList titles
        run: python match_titles.py

      - name: Commit results
        run: |
          git config user.name "anime-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data README.md || true
          git commit -m "data: update matched snapshot $(date -u +'%Y-%m-%d')" || echo "no changes to commit"
          git push
