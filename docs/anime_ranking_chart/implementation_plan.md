# ランキング推移機能実装計画

## ゴールの説明
「アニメコメントランキング」ページにおいて、ランキング種別に「ランキング推移（history）」を追加します。
選択された際、各作品のランキング推移（古い話数から最新話までの各話の順位）を、作品ごとに色を変えた折れ線グラフ（Chart.js利用）で表示します。
ランキング算出ロジックは、各作品の最新話からX話遡ったもの同士（放送時期の同じ話数同士）で比較し、遡れる作品数が全作品数の半分以下になった時点で遡るのを停止。そこをランキング推移の最古地点（グラフの左端）とし、最新話を右端として描画します。
既存ロジックには影響がないように追加します。

## ユーザーのレビューが必要な項目
とくに破壊的変更はありませんが、以下の仕様で進めます。
- グラフ描画には、追加のモジュールインストールなしで動作させるため、CDNから `Chart.js` を読み込んで利用します。
- UI上で、ランキング種別が「ランキング推移」のときはテーブルを非表示にし、グラフ用 `<canvas>` を表示する形とします。
- グラフの色は作品ごとに見分けがつくよう、Hue（色相）を等分した色（例: `hsl(...)`）を自動割り当てします。

## 変更の提案

### astro\src\pages

#### [MODIFY] index.astro (file:///d:/DATA/Create/Github/red-view/astro/src/pages/index.astro)
- `<head>` 内に `<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>` を追加。
- 「ランキング種別」セレクトボックスに `<option value="history">ランキング推移</option>` を追加。
- グラフ表示用の `<div id="chartContainer" style="display: none; height: 400px;"><canvas id="rankingChart"></canvas></div>` を追加。
- `loadAndRender` 関数内でのロジック分岐の追加
  - `mode === "history"` の場合：
    - アニメデータ全体から、最大の遡及可能数（`maxOffset`）を計算。（各作品の最新話から `offset` 遡った話が存在する作品数を数え、総作品数の半分以下でストップ）
    - `maxOffset` から順に `0`（最新話）までの各時点で、存在するエピソードのコメント数を比較して順位付けする。
    - 各アニメの順位データをX軸を `maxOffset`（左端） 〜 `0`（右端、最新話）として配列化。
    - X軸ラベルは「[最新話-N]話」から「[最新話]」などとする。
    - Chart.js のインスタンスを生成/更新し、ランキンググラフを描画する（Y軸はリバース設定にして1位が一番上にくるようにする）。
    - テーブル(`rankingBody`)のコンテナを非表示にし、グラフのコンテナを表示する。
  - それ以外の既存モードの場合：
    - ランキングのセル生成・テーブル表示処理（既存のまま）。
    - テーブルのコンテナを表示し、グラフのコンテナを非表示にする。

## 検証計画

### 手動検証
- ランキング種別のプルダウンで「ランキング推移」を選び、グラフが表示されることを確認。
- グラフのX軸が過去（左）から最新話（右）になっており、Y軸が1位（上）から下がっていく順位になっていることを確認。
- 遡る計算において、アニメ全作品中、指定話数を持つ作品が半数以下になる話数の手前でグラフが始まっているか（要件通りか）を確認。
- シーズン（seasonSelect）を変更した際、既存モードでも変更が反映されエラーが出ないこと、推移モードでもグラフが正しく更新されることを確認。
- 既存のモード（最新話コメント数など）の動作が影響を受けていないことを確認。
