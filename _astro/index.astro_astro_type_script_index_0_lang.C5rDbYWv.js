const g=document.getElementById("seasonSelect"),A=document.getElementById("modeSelect"),$=document.getElementById("rankingBody"),k=document.getElementById("tableContainer"),h=document.getElementById("chartContainer"),x=document.getElementById("rankingChart"),C=document.getElementById("selectedAnimeTitle");let p=null,f=null;const I=await fetch("data/reddit/seasons.json"),B=await I.json();B.forEach(y=>{const m=document.createElement("option");m.value=y.key+".json",m.textContent=y.label,g.appendChild(m)});g.value=B[0].key+".json";async function b(){const y=g.value,m=A.value,v=await(await fetch(`data/reddit/${y}`)).json();if(m==="history"){k.style.display="none",h.style.display="block",C.style.display="none";const a=Object.values(v.anime);let t=0;for(;;){let s=0;for(const e of a){const n=e.latest_episode-t;e.episodes&&e.episodes[n]&&e.episodes[n].length>0&&s++}if(s<=Math.floor(a.length/2))break;t++}t=Math.max(0,t-1);const i={};for(const s of a)i[s.name_jp]=[];for(let s=t;s>=0;s--){const e=[];for(const o of a){const r=o.latest_episode-s,j=o.episodes?.[r]?.[0]?.num_comments??0;e.push({name:o.name_jp,count:j,valid:j>0})}e.sort((o,r)=>r.count-o.count);let n=1;for(let o=0;o<e.length;o++){o>0&&e[o].count<e[o-1].count&&(n=o+1);const r=e[o].name;e[o].valid?i[r].push(n):i[r].push(null)}}const d=[];for(let s=t;s>=0;s--)s===0?d.push("最新話"):d.push(`最新話-${s}`);const u=[];let l=0;for(const s of a){const e=i[s.name_jp];if(e.every(r=>r===null))continue;const o=`hsl(${Math.floor(l*360/a.length)}, 70%, 50%)`;u.push({label:s.name_jp,data:e,borderColor:o,backgroundColor:o,fill:!1,tension:.1,spanGaps:!0}),l++}u.sort((s,e)=>{const n=s.data[s.data.length-1],o=e.data[e.data.length-1];return n===null&&o===null?0:n===null?1:o===null?-1:n-o});const c=u.length*25+100;h.style.height=`max(60vh, ${c}px)`,p&&p.destroy(),p=new Chart(x,{type:"line",data:{labels:d,datasets:u},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{reverse:!0,beginAtZero:!1,title:{display:!0,text:"順位"},ticks:{stepSize:1}}},plugins:{legend:{position:"right"}}}});return}if(m==="comments_history"){k.style.display="none",h.style.display="flex",h.style.flexDirection="column";const a=Object.values(v.anime),t=[];for(const e of a){const n=e.latest_episode,r=e.episodes?.[n]?.[0]?.num_comments??0;t.push({name:e.name_jp,count:r,animeData:e})}t.sort((e,n)=>n.count-e.count),!f&&t.length>0&&(f=t[0].name);let i=t.find(e=>e.name===f)?.animeData;!i&&t.length>0&&(f=t[0].name,i=t[0].animeData),C.style.display="block",C.textContent=f;const d=Object.keys(i.episodes||{}).map(Number).sort((e,n)=>e-n),u=d.map(e=>`第${e}話`),l={};a.forEach((e,n)=>{const o=Math.floor(n*360/a.length);l[e.name_jp]=`hsl(${o}, 70%, 50%)`});const c=t.map(e=>{const n=e.name===f,o=l[e.name];let r=[];return n&&(r=d.map(E=>e.animeData.episodes[E]?.[0]?.num_comments??0)),{label:e.name,data:r,backgroundColor:o,borderColor:o,type:"bar",barPercentage:.5,categoryPercentage:1}}),s=c.length*25+100;h.style.height=`max(60vh, ${s}px)`,p&&p.destroy(),p=new Chart(x,{type:"bar",data:{labels:u,datasets:c},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{stacked:!0},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:"コメント数"}}},plugins:{legend:{position:"right",onClick:function(e,n,o){f=n.text,b()}},tooltip:{filter:function(e){return e.dataset.data.length>0}}}}});return}k.style.display="block",h.style.display="none",p&&(p.destroy(),p=null);const _=[];for(const a of Object.values(v.anime)){let t=0,i="",d="";const u=a.latest_episode;if(m==="latest"){const l=a.episodes?.[u]?.[0];if(!l)continue;t=l.num_comments??0,i=`第${u}話`,d=l.url}if(m==="previous"){const l=u-1,c=a.episodes?.[l]?.[0];if(!c)continue;t=c.num_comments??0,i=`第${l}話`,d=c.url}if(m==="total"){let l=0,c="";for(const[s,e]of Object.entries(a.episodes??{}))for(const n of e)t+=n.num_comments??0,l++,Number(s)===u&&(c=n.url);if(l===0)continue;i=`全${l}話分`,d=c}if(m==="average"){let l=0,c="";for(const[s,e]of Object.entries(a.episodes??{}))for(const n of e)t+=n.num_comments??0,l++,Number(s)===u&&(c=n.url);if(l===0)continue;i=`全${l}話分`,d=c,t=Math.round(t/l)}_.push({title:a.name_jp,episodeLabel:i,count:t,url:d})}_.sort((a,t)=>t.count-a.count),$.innerHTML="",_.forEach((a,t)=>{$.insertAdjacentHTML("beforeend",`<tr>
                  <td>${t+1}</td>
                  <td>${a.title}</td>
                  <td>${a.episodeLabel}</td>
                  <td>${a.count}</td>
                  <td>
                    <a href="${a.url}" target="_blank" rel="noopener">URL</a>
                  </td>
                </tr>`)})}g.addEventListener("change",b);A.addEventListener("change",b);b();
